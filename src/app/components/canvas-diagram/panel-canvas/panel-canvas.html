<main
    #mainRef
    class="flex-1 bg-slate-50 dark:bg-[#0B1120] relative overflow-hidden transition-colors duration-200 touch-none w-full h-full"
    (pointerdown)="handleCanvasPointerDown($event)"
    (pointermove)="handlePointerMove($event)"
    (pointerup)="handlePointerUp($event)"
    (pointercancel)="handlePointerUp($event)"
    (contextmenu)="handleContextMenu($event)"
    [style.cursor]="cursorStyle()"
    [style.backgroundImage]="gridBackground()"
    [style.backgroundSize]="gridSize()"
    [style.backgroundPosition]="gridPosition()"
>
    <!-- Movable Canvas Layer -->
    <div
        class="absolute top-0 left-0 w-full h-full origin-top-left"
        [style.transform]="transformStyle()"
    >
        <!-- Infinite SVG Layer -->
        <svg
            class="absolute top-0 left-0 w-[10000px] h-[10000px] pointer-events-none z-0"
            style="transform: translate(-5000px, -5000px)"
        >
            <defs>
                <g cardinality-markers [theme]="theme()"></g>
            </defs>

            <g transform="translate(5000, 5000)">
                <!-- RELATIONSHIPS -->
                @for (rel of renderedRelationships(); track rel.id) {
                    <g
                        class="pointer-events-auto cursor-pointer group"
                        (pointerdown)="$event.stopPropagation()"
                        (click)="handleRelClick($event, rel.id)"
                        (contextmenu)="handleRelContextMenu($event, rel.id)"
                        (dblclick)="handleRelDoubleClick($event, rel.id)"
                        (pointerenter)="hoveredRelId.set(rel.id)"
                        (pointerleave)="hoveredRelId.set(null)"
                    >
                        <!-- Hit Area Path -->
                        <path
                            [attr.d]="rel.path"
                            stroke="red"
                            stroke-opacity="0"
                            stroke-width="30"
                            fill="none"
                        />
                        <!-- Visual path -->
                        <path
                            [attr.d]="rel.path"
                            [attr.stroke]="rel?.isSelected ? '#2563eb' : strokeColor()"
                            [attr.stroke-width]="rel?.isSelected ? '2.5' : '1.5'"
                            fill="none"
                            [attr.marker-start]="rel.markerStart"
                            [attr.marker-end]="rel.markerEnd"
                            [attr.stroke-dasharray]="rel?.dashArray"
                            class="transition-colors duration-200"
                        />

                        <!-- Numeric Cardinality Labels -->
                        @if (rel.numericLabels; as labels) {
                            <text
                                [attr.x]="labels.start.x"
                                [attr.y]="labels.start.y"
                                [attr.text-anchor]="labels.start.anchor"
                                [attr.stroke]="theme() === 'dark' ? '#0B1120' : '#f8fafc'"
                                stroke-width="3"
                                paint-order="stroke"
                                class="text-[12px] font-bold font-mono pointer-events-none select-none fill-slate-500 dark:fill-slate-400"
                            >
                                {{ labels.start.text }}
                            </text>

                            <text
                                [attr.x]="labels.end.x"
                                [attr.y]="labels.end.y"
                                [attr.text-anchor]="labels.end.anchor"
                                [attr.stroke]="theme() === 'dark' ? '#0B1120' : '#f8fafc'"
                                stroke-width="3"
                                paint-order="stroke"
                                class="text-[12px] font-bold font-mono pointer-events-none select-none fill-slate-500 dark:fill-slate-400"
                            >
                                {{ labels.end.text }}
                            </text>
                        }

                        <!-- Control Points & Segments -->
                        @if (rel.showControls) {
                            @for (seg of rel.segments; track $index) {
                                <rect
                                    [attr.x]="seg.x"
                                    [attr.y]="seg.y"
                                    [attr.width]="seg.width"
                                    [attr.height]="seg.height"
                                    rx="2"
                                    fill="#3b82f6"
                                    stroke="black"
                                    stroke-width="1"
                                    class="cursor-move hover:fill-blue-400"
                                    (pointerdown)="
                                        handleSegmentPointerDown(
                                            $event,
                                            rel.id,
                                            seg.index,
                                            seg.orientation,
                                            seg.x,
                                            seg.y
                                        )
                                    "
                                    (click)="$event.stopPropagation()"
                                />
                            }

                            <!-- Draggable Handles -->
                            @for (handle of rel.handles; track $index) {
                                @let isSelected =
                                    selectedControlPoint()?.relId === rel.id &&
                                    selectedControlPoint()?.index === handle.index;
                                <g>
                                    <circle
                                        [attr.cx]="handle.x"
                                        [attr.cy]="handle.y"
                                        r="4"
                                        [attr.fill]="isSelected ? '#f97316' : '#10b981'"
                                        [attr.stroke]="isSelected ? '#fff7ed' : 'white'"
                                        [attr.stroke-width]="isSelected ? 2 : 1.5"
                                        class="cursor-move drop-shadow-md transition-colors"
                                        [class.hover:fill-emerald-400]="!isSelected"
                                        [class.hover:fill-orange-400]="isSelected"
                                        (pointerdown)="
                                            handleControlPointPointerDown(
                                                $event,
                                                rel.id,
                                                handle.index,
                                                handle.x,
                                                handle.y
                                            )
                                        "
                                        (click)="$event.stopPropagation()"
                                        (dblclick)="
                                            $event.stopPropagation();
                                            deleteControlPoint.emit({
                                                relId: rel.id,
                                                index: handle.index,
                                            })
                                        "
                                    />
                                </g>
                            }
                        }

                        <!-- Relationship Label -->
                        @if (viewOptions().showRelationshipNames && rel.name && rel.labelWidth) {
                            <g
                                [attr.transform]="
                                    'translate(' + rel?.midpoint?.x + ', ' + rel?.midpoint?.y + ')'
                                "
                            >
                                <rect
                                    [attr.x]="-(rel.labelWidth / 2)"
                                    y="-9"
                                    [attr.width]="rel.labelWidth"
                                    height="18"
                                    rx="4"
                                    [attr.fill]="theme() === 'dark' ? '#1e293b' : '#f8fafc'"
                                    [attr.stroke]="theme() === 'dark' ? '#475569' : '#cbd5e1'"
                                    stroke-width="1"
                                    class="shadow-sm"
                                />
                                <text
                                    x="0"
                                    y="3"
                                    text-anchor="middle"
                                    class="text-[10px] font-mono font-bold pointer-events-none select-none"
                                    [class]="
                                        rel.isSelected
                                            ? 'fill-blue-600 dark:fill-blue-400'
                                            : 'fill-slate-600 dark:fill-slate-300'
                                    "
                                >
                                    {{ rel.name }}
                                </text>
                            </g>
                        }
                    </g>
                }

                <!-- Temp Connection -->
                @if (isConnecting() && tempConnection(); as temp) {
                    <path
                        [attr.d]="
                            'M ' +
                            temp.startX +
                            ' ' +
                            temp.startY +
                            ' L ' +
                            mousePos().x +
                            ' ' +
                            mousePos().y
                        "
                        stroke="#3b82f6"
                        stroke-width="2"
                        stroke-dasharray="5,5"
                        fill="none"
                        marker-end="url(#oneManyEnd)"
                    />
                }
            </g>
        </svg>

        <!-- TABLES -->
        @for (table of tables(); track table.id) {
            <table-node
                [table]="table"
                [tables]="tables()"
                [isSelected]="
                    selectedId() === table.id || (selectedTableIds()?.has(table.id) ?? false)
                "
                [viewMode]="viewMode()"
                [viewOptions]="viewOptions()"
                [isConnecting]="isConnecting()"
                [tempConnection]="tempConnection()"
                [zoom]="zoom()"
                [dbEngine]="dbEngine()"
                [globalEditable]="globalEditable()"
                (onPointerDown)="handleTableDown($event)"
                (startConnection)="handleStartConnection($event)"
                (completeConnection)="handleCompleteConnection($event)"
                (completeNewColConnection)="handleCompleteNewColConnection($event)"
                (addColumn)="addColumn.emit($event)"
                (updateTable)="updateTable.emit($event)"
                (updateColumn)="updateColumn.emit($event)"
                (moveColumn)="moveColumn.emit($event)"
                (deleteColumn)="deleteColumn.emit($event)"
                (config)="configTable.emit(table.id)"
                (tableDoubleClick)="handleTableDoubleClick($event)"
            />
        }
    </div>

    <!-- Marquee -->
    @if (isSelecting() && selectionBox()) {
        <div
            class="absolute border border-blue-500 bg-blue-500/20 pointer-events-none z-50"
            [style.left.px]="selectionRect().x"
            [style.top.px]="selectionRect().y"
            [style.width.px]="selectionRect().w"
            [style.height.px]="selectionRect().h"
        ></div>
    }

    <!-- Minimap -->
    @if (viewOptions().showMinimap) {
        <minimap
            [tables]="tables()"
            [relationships]="relationships()"
            [viewOptions]="viewOptions()"
            [zoom]="zoom()"
            [pan]="pan()"
            [containerWidth]="containerSize().width"
            [containerHeight]="containerSize().height"
            [theme]="theme()"
            (panChange)="setPan($event)"
        />
    }

    <!-- Zoom Controls -->
    @if (viewOptions().showZoomControls) {
        <div class="absolute bottom-6 left-6 z-40 flex items-end gap-3">
            <div
                class="bg-white/90 dark:bg-slate-800/90 backdrop-blur-sm border border-slate-200 dark:border-slate-700 p-1.5 rounded-lg shadow-lg flex flex-col items-center gap-1"
            >
                <button
                    (click)="updateZoom(0.1)"
                    class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-md text-slate-600 dark:text-slate-300 transition-colors"
                    title="Zoom In"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <circle cx="11" cy="11" r="8" />
                        <line x1="21" x2="16.65" y1="21" y2="16.65" />
                        <line x1="11" x2="11" y1="8" y2="14" />
                        <line x1="8" x2="14" y1="11" y2="11" />
                    </svg>
                </button>
                <div
                    class="w-10 py-1 text-center font-mono text-[10px] font-bold text-slate-500 dark:text-slate-400 border-y border-slate-100 dark:border-slate-700 my-0.5 select-none"
                >
                    {{ zoomPercentage() }}%
                </div>
                <button
                    (click)="updateZoom(-0.1)"
                    class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-md text-slate-600 dark:text-slate-300 transition-colors"
                    title="Zoom Out"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <circle cx="11" cy="11" r="8" />
                        <line x1="21" x2="16.65" y1="21" y2="16.65" />
                        <line x1="8" x2="14" y1="11" y2="11" />
                    </svg>
                </button>
                <button
                    (click)="resetView()"
                    class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-md text-slate-600 dark:text-slate-300 transition-colors border-t border-slate-100 dark:border-slate-700 mt-1"
                    title="Reset View"
                >
                    <!-- Maximize / Fit Icon -->
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <polyline points="15 3 21 3 21 9" />
                        <polyline points="9 21 3 21 3 15" />
                        <line x1="21" x2="14" y1="3" y2="10" />
                        <line x1="3" x2="10" y1="21" y2="14" />
                    </svg>
                </button>
            </div>
        </div>
    }
</main>
