<div
    class="absolute bg-white dark:bg-slate-800 border shadow-sm rounded-lg overflow-visible select-none group/table"
    [class.border-blue-500]="isSelected()"
    [class.shadow-xl]="isSelected()"
    [class.ring-2]="isSelected()"
    [class.ring-blue-100]="isSelected()"
    [class.dark:ring-blue-900]="isSelected()"
    [class.z-30]="isSelected()"
    [class.border-slate-300]="!isSelected()"
    [class.dark:border-slate-600]="!isSelected()"
    [class.hover:border-slate-400]="!isSelected()"
    [class.dark:hover:border-slate-500]="!isSelected()"
    [class.z-10]="!isSelected() && !isExpanded()"
    [class.z-20]="!isSelected() && isExpanded()"
    [style.left.px]="table().x"
    [style.top.px]="table().y"
    [style.width.px]="width()"
    [style.min-width.px]="TABLE_WIDTH"
    [style.max-width.px]="600"
    [style.cursor]="isLocked() ? 'default' : 'move'"
    (pointerdown)="handlePointerDown($event)"
    (pointerup)="handleTableConnectionDrop($event)"
    (contextmenu)="handleContextMenu($event)"
    (dblclick)="tableDoubleClick.emit(table().id)"
>
    <table-header
        [table]="table()"
        [tables]="tables()"
        [viewMode]="viewMode()"
        [isSelected]="isSelected()"
        [isLocked]="isLocked()"
        [isExpanded]="isExpanded()"
        (toggleExpand)="toggleExpand()"
        (updateTable)="handleUpdateTable($event)"
        (config)="config.emit()"
    />

    <div class="flex flex-col bg-white dark:bg-[#0d1527] rounded-b-lg pb-1 relative">
        @for (col of table().columns; track col.id; let idx = $index) {
            <table-row
                [col]="col"
                [index]="idx"
                [viewMode]="viewMode()"
                [viewOptions]="viewOptions()"
                [isLocked]="isLocked()"
                [isSelected]="isSelected()"
                [isConnecting]="isConnecting()"
                [isExpanded]="isExpanded()"
                [dbEngine]="dbEngine()"
                [isDragging]="draggedIndex() === idx"
                (dragStart)="handleDragStart($event, idx)"
                (drop)="handleDrop($event, idx)"
                (startConnection)="handleRowConnectionStart($event, col.id)"
                (completeConnection)="handleRowConnectionComplete($event, col.id)"
                (updateColumn)="handleUpdateColumn(col.id, $event)"
                (deleteColumn)="deleteColumn.emit({ tableId: table().id, colId: col.id })"
            />
        }

        <!-- New Column Drop Zone -->
        @if (showNewColDropZone()) {
            <div
                class="flex items-center justify-center h-[28px] mx-1 mb-1 mt-1 bg-green-50 dark:bg-green-900/20 border border-dashed border-green-300 dark:border-green-700 rounded hover:bg-green-100 dark:hover:bg-green-900/40 cursor-copy transition-colors animate-pulse"
                (pointerup)="completeNewColConnection.emit({ event: $event, tableId: table().id })"
                title="Drop to create new FK column automatically"
            >
                <!-- CopyPlus -->
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="text-green-600 dark:text-green-400 mr-1.5"
                >
                    <rect width="14" height="14" x="8" y="8" rx="2" ry="2" />
                    <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" />
                    <line x1="15" x2="15" y1="12" y2="18" />
                    <line x1="12" x2="18" y1="15" y2="15" />
                </svg>
                <span
                    class="text-[10px] font-bold text-green-700 dark:text-green-300 uppercase tracking-tight"
                >
                    New FK Column
                </span>
            </div>
        }
    </div>

    <!-- Table Connection Points (Visible only in Table Mode) -->
    @if (showTableConnectors()) {
        <!-- Left -->
        <div
            class="absolute w-3 h-3 bg-blue-500 border-2 border-white dark:border-slate-800 rounded-full cursor-crosshair shadow-sm z-50 transition-all duration-200 hover:scale-125 -left-1.5 top-1/2 -translate-y-1/2"
            [class.opacity-0]="!isSelected()"
            [class.scale-50]="!isSelected()"
            [class.group-hover/table:opacity-100]="!isSelected()"
            [class.group-hover/table:scale-100]="!isSelected()"
            (pointerdown)="handleTableConnectionStart($event, 'left')"
        ></div>

        <!-- Right -->
        <div
            class="absolute w-3 h-3 bg-blue-500 border-2 border-white dark:border-slate-800 rounded-full cursor-crosshair shadow-sm z-50 transition-all duration-200 hover:scale-125 -right-1.5 top-1/2 -translate-y-1/2"
            [class.opacity-0]="!isSelected()"
            [class.scale-50]="!isSelected()"
            [class.group-hover/table:opacity-100]="!isSelected()"
            [class.group-hover/table:scale-100]="!isSelected()"
            (pointerdown)="handleTableConnectionStart($event, 'right')"
        ></div>

        <!-- Top -->
        <div
            class="absolute w-3 h-3 bg-blue-500 border-2 border-white dark:border-slate-800 rounded-full cursor-crosshair shadow-sm z-50 transition-all duration-200 hover:scale-125 left-1/2 -top-1.5 -translate-x-1/2"
            [class.opacity-0]="!isSelected()"
            [class.scale-50]="!isSelected()"
            [class.group-hover/table:opacity-100]="!isSelected()"
            [class.group-hover/table:scale-100]="!isSelected()"
            (pointerdown)="handleTableConnectionStart($event, 'top')"
        ></div>

        <!-- Bottom -->
        <div
            class="absolute w-3 h-3 bg-blue-500 border-2 border-white dark:border-slate-800 rounded-full cursor-crosshair shadow-sm z-50 transition-all duration-200 hover:scale-125 left-1/2 -bottom-1.5 -translate-x-1/2"
            [class.opacity-0]="!isSelected()"
            [class.scale-50]="!isSelected()"
            [class.group-hover/table:opacity-100]="!isSelected()"
            [class.group-hover/table:scale-100]="!isSelected()"
            (pointerdown)="handleTableConnectionStart($event, 'bottom')"
        ></div>
    }

    <!-- Quick Add Column -->
    @if (isLocked()) {
        <div
            class="absolute -bottom-3 left-1/2 -translate-x-1/2 z-20 transition-opacity duration-200"
            [class.opacity-100]="isSelected()"
            [class.opacity-0]="!isSelected()"
            [class.group-hover/table:opacity-100]="!isSelected()"
            (mousedown)="$event.stopPropagation()"
            (click)="$event.stopPropagation(); addColumn.emit(table().id)"
        >
            <div
                class="bg-blue-600 dark:bg-blue-500 text-white rounded-full p-1 shadow-md border-2 border-white dark:border-slate-700 hover:scale-110 active:scale-95 transition-transform cursor-pointer"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="3"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                >
                    <line x1="12" x2="12" y1="5" y2="19" />
                    <line x1="5" x2="19" y1="12" y2="12" />
                </svg>
            </div>
        </div>
    }
</div>
