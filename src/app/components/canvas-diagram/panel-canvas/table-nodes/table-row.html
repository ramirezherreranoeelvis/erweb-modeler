<div
      [draggable]="isLocked() && !isConnecting()"
      (dragstart)="onDragStart($event)"
      (dragover)="$event.preventDefault(); $event.stopPropagation()"
      (drop)="onDrop($event)"
      class="group/row relative flex items-center px-3 py-1 text-xs border-b border-transparent transition-colors"
      [class.opacity-30]="isDragging()"
      [class]="isValid() 
        ? 'hover:bg-blue-50 dark:hover:bg-slate-700 hover:border-blue-100 dark:hover:border-slate-600' 
        : 'bg-red-50 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/30'"
      [style.height]="isExpanded() ? 'auto' : '28px'"
      (pointerup)="handlePointerUp($event)"
    >
      <!-- Drag Grip -->
      @if (isLocked()) {
        <div class="absolute left-0.5 top-1/2 -translate-y-1/2 opacity-0 group-hover/row:opacity-100 cursor-grab text-slate-300 hover:text-slate-500">
          <!-- GripVertical -->
          <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg>
        </div>
      }

      <!-- Connection Dots -->
      @if (!col().isFk && showDots()) {
        <div
          class="absolute -left-1.5 top-1/2 -translate-y-1/2 w-3 h-3 bg-blue-500 border-2 border-white dark:border-slate-800 rounded-full cursor-crosshair shadow-sm z-20 hover:scale-125 transition-all"
          [class]="isSelected() ? 'block opacity-100' : 'hidden group-hover/row:block opacity-100'"
          (pointerdown)="startConnection.emit({side: 'left', event: $event})"
        ></div>
        <div
          class="absolute -right-1.5 top-1/2 -translate-y-1/2 w-3 h-3 bg-blue-500 border-2 border-white dark:border-slate-800 rounded-full cursor-crosshair shadow-sm z-20 hover:scale-125 transition-all"
          [class]="isSelected() ? 'block opacity-100' : 'hidden group-hover/row:block opacity-100'"
          (pointerdown)="startConnection.emit({side: 'right', event: $event})"
        ></div>
      }

      <!-- Icons (PK/FK) -->
      <div class="w-10 shrink-0 flex items-center gap-0.5 ml-2">
        @if (viewOptions().showPk && col().isPk) {
          <!-- Solid Key Icon -->
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor" class="text-amber-500">
            <path d="M12.65 10C11.83 7.67 9.61 6 7 6a6 6 0 0 0 0 12c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4H12.65zM7 14a2 2 0 1 1 0-4 2 2 0 0 1 0 4z"/>
          </svg>
        } @else {
          <span class="w-3"></span>
        }
        @if (viewOptions().showFk && col().isFk && !col().isPk) {
          <div class="text-[8px] font-bold text-slate-500 dark:text-slate-400 bg-slate-100 dark:bg-slate-700 px-1 rounded border border-slate-200 dark:border-slate-600">
            FK
          </div>
        }
      </div>

      <!-- Column Name -->
      <div 
        class="flex-1 truncate mr-2"
        (dblclick)="$event.stopPropagation(); isLocked() && startEditing('name', viewMode() === 'physical' ? col().name : col().logicalName)"
      >
        @if (editingField() === 'name') {
          <input
            #inlineInput
            autoFocus
            [ngModel]="editValue()"
            (ngModelChange)="editValue.set($event)"
            (blur)="saveEdit()"
            (keydown.enter)="saveEdit()"
            (keydown.escape)="cancelEdit()"
            (mousedown)="$event.stopPropagation()"
            class="w-full text-xs p-0 border-b border-blue-500 outline-none bg-transparent text-slate-900 dark:text-slate-100"
          />
        } @else {
          <span
            [class]="col().isPk ? 'font-bold text-slate-800 dark:text-slate-100' : 'text-slate-600 dark:text-slate-300'"
            class="hover:text-blue-600 dark:hover:text-blue-400 cursor-text"
          >
            {{ viewMode() === 'physical' ? col().name : col().logicalName }}
          </span>
        }
      </div>

      <!-- Column Metadata -->
      <div class="flex items-center gap-1 text-[9px] font-mono text-slate-400 dark:text-slate-500">
        @if (viewMode() === 'physical' && viewOptions().showTypes) {
          <!-- Type -->
          <div (dblclick)="$event.stopPropagation(); isLocked() && startEditing('type', col().type)">
            @if (editingField() === 'type') {
              <select
                autoFocus
                [ngModel]="editValue()"
                (ngModelChange)="handleTypeChange($event)"
                (blur)="saveEdit()"
                (mousedown)="$event.stopPropagation()"
                class="text-[9px] p-0 border border-blue-300 rounded outline-none bg-white dark:bg-slate-700 text-slate-900 dark:text-white"
              >
                @for (type of availableTypes(); track type) {
                  <option [value]="type">{{ type.toLowerCase() }}</option>
                }
              </select>
            } @else {
              <span 
                class="cursor-pointer" 
                [class]="isValid() ? 'hover:text-blue-500 dark:hover:text-blue-400' : 'text-red-600 font-bold'"
              >
                {{ col().type.toUpperCase() }}
              </span>
            }
          </div>

          <!-- Length -->
          <!-- Logic Change: Only show parens if col().length actually has a value -->
          @if (viewOptions().showLength && col().length) {
            @if (editingField() === 'length') {
              <span class="flex items-center">
                (
                <input
                  autoFocus
                  [ngModel]="editValue()"
                  (ngModelChange)="editValue.set($event)"
                  (blur)="saveEdit()"
                  (keydown.enter)="saveEdit()"
                  (keydown.escape)="cancelEdit()"
                  (mousedown)="$event.stopPropagation()"
                  class="w-6 text-[9px] p-0 border-b border-blue-500 outline-none bg-transparent text-center text-slate-900 dark:text-slate-100"
                />
                )
              </span>
            } @else {
              <span
                class="cursor-pointer hover:text-blue-400 dark:hover:text-blue-400 truncate max-w-[100px] inline-block align-bottom"
                [class]="isValid() ? 'text-slate-300 dark:text-slate-500' : 'text-red-400'"
                (dblclick)="$event.stopPropagation(); isLocked() && startEditing('length', col().length)"
              >
                ({{ col().length }})
              </span>
            }
          }
        }

        <!-- Constraints Badges -->
        @if (viewOptions().showDefaultValue && col().defaultValue) {
          <span class="ml-1 text-[8px] bg-teal-50 dark:bg-teal-900/30 text-teal-600 dark:text-teal-400 px-1 rounded border border-teal-100 dark:border-teal-800 truncate max-w-[40px]" [title]="'Default: ' + col().defaultValue">
            {{ col().defaultValue }}
          </span>
        }

        @if (viewOptions().showIdentity && col().isIdentity) {
          <span class="ml-1 text-[8px] bg-purple-100 dark:bg-purple-900/40 text-purple-700 dark:text-purple-300 px-1 rounded border border-purple-200 dark:border-purple-800 font-bold">
            {{ dbEngine() === 'mysql' ? 'AI' : 'ID' }}
          </span>
        }

        @if (viewOptions().showUnique && col().isUnique) {
          <span class="ml-0.5 text-[8px] bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-300 px-1 rounded border border-green-200 dark:border-green-800 font-bold">
            UQ
          </span>
        }

        @if (viewOptions().showNulls) {
          <span 
            class="ml-1 font-bold" 
            [class]="col().isNullable ? 'text-blue-300 dark:text-blue-700' : 'text-slate-300 dark:text-slate-500'"
          >
            {{ col().isNullable ? 'NULL' : 'NN' }}
          </span>
        }
      </div>

      <!-- Delete Button (Only Locked) -->
      @if (isLocked()) {
        <div
          (mousedown)="$event.stopPropagation()"
          (click)="$event.stopPropagation(); deleteColumn.emit()"
          class="absolute right-0 top-0 bottom-0 w-7 flex items-center justify-center bg-white/90 dark:bg-slate-800/90 opacity-0 group-hover/row:opacity-100 hover:text-red-600 dark:hover:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/30 cursor-pointer transition-all border-l border-slate-100 dark:border-slate-700"
        >
          <!-- Trash2 -->
          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
        </div>
      }
    </div>