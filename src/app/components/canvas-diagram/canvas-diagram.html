<div
    class="relative w-full h-full overflow-hidden bg-slate-50 dark:bg-[#0B1120]"
    (click)="relMenuData.set(null); canvasMenuData.set(null)"
>
    <!-- MODALS & OVERLAYS -->

    @if (warningData()) {
        <modal-warning
            [data]="warningData()!"
            (cancel)="warningData.set(null)"
            (confirmIntegrity)="
                schema.applyConnection(
                    warningData()!.data.sourceTId,
                    warningData()!.data.sourceCId,
                    warningData()!.data.targetTId,
                    warningData()!.data.targetCId!
                );
                warningData.set(null)
            "
            (resolveCollision)="resolveCollision($event.action, { targetCId: $event.targetCId })"
        />
    }

    @if (showImportModal()) {
        <modal-import
            [dbEngine]="schema.dbEngine()"
            (close)="showImportModal.set(false)"
            (importData)="handleImportData($event)"
        />
    }

    @if (isConversionModalOpen() && targetDbEngine()) {
        <modal-type-conversion
            [targetEngine]="targetDbEngine()!"
            [changes]="conversionChanges()"
            (autoConvert)="confirmConversion($event)"
            (keepAsIs)="keepAsIs()"
            (cancel)="abortConversion()"
        />
    }

    <!-- CORE CANVAS -->
    <panel-canvas
        [tables]="schema.tables()"
        [relationships]="schema.relationships()"
        [viewOptions]="viewOptions()"
        [viewMode]="schema.viewMode()"
        [dbEngine]="schema.dbEngine()"
        [theme]="theme()"
        [globalEditable]="globalEditable()"
        [selectedId]="selectedId()"
        [selectedTableIds]="selectedTableIds()"
        (selectId)="selectedId.set($event)"
        (selectTableIds)="selectedTableIds.set($event)"
        (openTableProperties)="selectedId.set($event)"
        (relationshipClick)="relMenuData.set($event)"
        (applyConnection)="handleApplyConnection($event)"
        (reconnectRelationship)="handleReconnect($event)"
        (createFkConnection)="handleCreateFkConnection($event)"
        (updateTable)="schema.updateTable($event.id, $event.field, $event.value)"
        (tablePositionChange)="schema.updateTablePosition($event.id, $event.x, $event.y)"
        (updateColumn)="
            schema.updateColumn($event.tableId, $event.colId, $event.field, $event.value)
        "
        (moveColumn)="schema.moveColumn($event.tableId, $event.fromIndex, $event.toIndex)"
        (deleteColumn)="schema.deleteColumn($event.tableId, $event.colId)"
        (addColumn)="schema.addColumn($event)"
        (configTable)="selectedId.set($event)"
        (controlPointChange)="
            schema.updateControlPoint($event.relId, $event.index, $event.x, $event.y)
        "
        (controlPointsSet)="schema.setControlPoints($event.relId, $event.points)"
        (addControlPoint)="schema.addControlPoint($event.relId, $event.x, $event.y, $event.index)"
        (deleteControlPoint)="schema.deleteControlPoint($event.relId, $event.index)"
        (clearMenus)="relMenuData.set(null); canvasMenuData.set(null)"
        (contextmenu)="
            canvasMenuData.set({ x: $event.clientX, y: $event.clientY }); $event.preventDefault()
        "
    />

    <!-- CONTEXT MENUS -->

    @if (relMenuData() && activeRel()) {
        <menu-relationship
            [x]="relMenuData()!.x"
            [y]="relMenuData()!.y"
            [currentName]="activeRel()!.name"
            [currentType]="activeRel()!.type"
            [targetColNullable]="targetColNullable()"
            (updateName)="schema.updateRelName(activeRel()!.id, $event)"
            (updateCardinality)="
                schema.updateCardinality(activeRel()!.id, $event.type, $event.isNullable)
            "
            (resetRouting)="schema.resetRelRouting(activeRel()!.id); relMenuData.set(null)"
            (setRouting)="
                schema.setRelRouting(activeRel()!.id, $event.source, $event.target);
                relMenuData.set(null)
            "
            (deleteRel)="handleDeleteRel()"
        />
    }

    @if (canvasMenuData()) {
        <menu-context
            [x]="canvasMenuData()!.x"
            [y]="canvasMenuData()!.y"
            [viewOptions]="viewOptions()"
            [viewMode]="schema.viewMode()"
            [dbEngine]="schema.dbEngine()"
            (updateViewOption)="updateViewOption.emit($event)"
            (updateViewMode)="updateViewMode.emit($event)"
            (updateDbEngine)="updateDbEngineRequest.emit($event)"
            (close)="canvasMenuData.set(null)"
        />
    }
</div>
