<div [class]="theme()">
    <div
        class="flex flex-col h-screen w-full bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100 font-sans overflow-hidden transition-colors duration-200"
    >
        <toolbar
            [viewMode]="schema.viewMode()"
            (viewModeChange)="schema.setViewMode($event)"
            [dbEngine]="schema.dbEngine()"
            (dbEngineChange)="handleDbEngineRequest($event)"
            (toggleSidebar)="handleToggleSidebar()"
            (onExport)="handleExport($event)"
            (onImportClick)="handleImportClick()"
            (onReset)="handleReset()"
        />

        <div class="flex flex-1 overflow-hidden relative">
            @if (isSidebarOpen()) {
                <div
                    class="md:hidden fixed inset-0 bg-black/50 z-20 backdrop-blur-sm"
                    (click)="isSidebarOpen.set(false)"
                ></div>
            }

            <sidebar
                [isOpen]="isSidebarOpen()"
                [globalEditable]="globalEditable()"
                (globalEditableChange)="globalEditable.set($event)"
                [selectedId]="activeTableId()"
                [viewOptions]="viewOptions()"
                [dbEngine]="schema.dbEngine()"
                (viewOptionsChange)="viewOptions.set($event)"
                (addTable)="handleAddTable()"
                (deleteTable)="handleDeleteTable()"
            />

            <!-- Main Diagram Panel -->
            <canvas-diagram
                class="flex-1"
                [viewOptions]="viewOptions()"
                [theme]="theme()"
                [globalEditable]="globalEditable()"
                [targetDbEngine]="pendingDbEngine()"
                (tableSelected)="handleTableSelection($event)"
                (updateViewOption)="handleUpdateViewOption($event)"
                (updateViewMode)="handleViewModeChange($event)"
                (updateDbEngineRequest)="handleDbEngineRequest($event)"
                (requestHandled)="handleRequestHandled()"
            />

            <!-- Properties Panel (Rendered by App, triggered by PanelDiagram selection) -->
            @if (activeTableId()) {
                <div
                    class="fixed inset-0 z-40 md:static md:z-auto md:w-auto bg-white/50 dark:bg-black/50 backdrop-blur-sm md:bg-transparent md:backdrop-blur-none flex flex-col justify-end md:block"
                >
                    <properties-panel
                        [tables]="schema.tables()"
                        [selectedTableId]="activeTableId()!"
                        [dbEngine]="schema.dbEngine()"
                        [(width)]="propertiesPanelWidth"
                        (close)="closePropertiesPanel()"
                        (updateTable)="schema.updateTable($event.id, $event.field, $event.value)"
                        (updateColumn)="
                            schema.updateColumn(
                                $event.tableId,
                                $event.colId,
                                $event.field,
                                $event.value
                            )
                        "
                        (addColumn)="schema.addColumn($event)"
                        (deleteColumn)="schema.deleteColumn($event.tableId, $event.colId)"
                        (moveColumn)="
                            schema.moveColumn($event.tableId, $event.fromIndex, $event.toIndex)
                        "
                    />
                </div>
            }
        </div>
    </div>
</div>
